# 快速開始
## IDE選擇

- intellij、goland、vscode任選

## 啟動程式進行debug

- 以goland為例, intellij應該也是一樣
    ```
    第一次設定時參考
    images/debug-1.png 
    images/debug-2.png
    images/debug-3.png
    
    之後只要
    images/debug-1.png
    ```


## 如果還沒安裝開發環境

- 安裝golang sdk
    ```
    #mac
    brew install go
    
    # Error: Cannot install in Homebrew on ARM processor in Intel default prefix (/usr/local)!
    (cd /opt
    sudo mkdir homebrew
    sudo git clone https://github.com/Homebrew/brew homebrew
    eval "$(homebrew/bin/brew shellenv)"
    sudo chown -R $(whoami) /opt/homebrew
    brew update --force --quiet
    chmod -R go-w "$(brew --prefix)/share/zsh"
    )
    
    export GOROOT="$(brew --prefix golang)/libexec"
    export GOPATH=$HOME/go
    export PATH=$PATH:$GOPATH/bin
    
    brew install protobuf
    brew install protoc-gen-go
    
    go install github.com/swaggo/swag/cmd/swag@latest
    go install github.com/google/wire/cmd/wire@latest
    go install github.com/golang/mock/gomock@latest
    go install github.com/golang/mock/mockgen@latest
    ```

- 开启GO111MODULE
    ```
    go env -w GO111MODULE=on
    ```

- 安裝kratos
    ```
    go install github.com/go-kratos/kratos/cmd/kratos/v2@latest
    ```

- 永久設定環境變數
    ```
    1.終端機使用bash的人:
    echo 'export GO111MODULE=on' >> ~/.bash_profile
    echo 'export GOPATH=$HOME/go' >> ~/.bash_profile
    echo 'export PATH=$PATH:$GOPATH/bin' >> ~/.bash_profile
    source ~/.bash_profile
  
    2.終端機使用zsh的人:
    echo 'export GO111MODULE=on' >> ~/.zprofile
    echo 'export GOPATH=$HOME/go' >> ~/.zprofile
    echo 'export PATH=$PATH:$GOPATH/bin' >> ~/.zprofile
    source ~/.zprofile
  
    補充說明:
    請自行在$HOME/go目錄內建一個src, 之後go專案都放到src裡面
    之後當go get安裝一些第三方工具, 檔案預設會放到$HOME/go/pkg
    若是go install, 預設會被放到$HOME/go/bin
    所以當執行命令缺少lib或是版本不對時, 通常就是檢查bin和pkg, 或是看brew有沒有安裝相關工具
  
    補充說明bash:
    mac內建bash是3.2, 如果想升級到5.x版本跟主流linux用的版本一致的話, 依照以下流程
    (1) brew安裝bash
        brew install bash
    (2) 讓bash預設使用剛剛安裝的新版
        vim ~/.bash_profile
        export PATH=/opt/homebrew/opt/bash/bin:$PATH    (這行加到所有export PATH之前, 保存離開)
    ```

## 如果.proto檔異動, 如何重新生成代碼
- 打開終端機, 確認在專案的根目錄操作
    ```
    make api     (/api目錄內.proto檔異動時使用)
    make config  (其他目錄proto檔異動使用)
    make all     (懶得思考時可以一律用這個)
    請注意產出的檔案上面的工具版本號, 隨便找一個生成的xxx.pb.go打開可以看到格式如下:
    
    // Code generated by protoc-gen-go-http. DO NOT EDIT.
    // versions:
    // - protoc-gen-go-http v2.6.3          <== 注意自己產出的版本號是否跟之前不同
    // - protoc             v4.23.3         <== 注意自己產出的版本號是否跟之前不同
    // source: chat/v1/chat.proto
    
    避免因為工具版本和別人不同, 產出的檔案內容其實沒變, 只是註解不同就被git列為已修改
    一個make可能就跑出十幾個已修改檔案, 造成commit的麻煩
    而且版本不一致也可能A打包運行沒問題, B打包運行有問題, 發生神奇bug找不到, 所以最好是統一比較好
    這兩個工具, 就是上面透過brew安裝的
    ```

- 打開終端機, 在根目錄/cmd/go-cs操作
    ```
    wire
    wire是依賴注入工具, 雖然編譯時期就執行比較麻煩一點但效能較好, 也能儘早發現錯誤
    這個指令可以不記, 在根目錄打make all就包含了wire的動作
    ```

## 如果新增了一組子功能模塊(api、service、server、biz、data), 如何讓它開始運作?
- 模塊之間的引用關係, 是透過wire的方式在編譯時注入依賴(生成wire_gen.go), 所以必須讓自己新增的子模塊能夠被wire找到
- 至少需要以下兩個步驟:
- (1) 加入wire的ProviderSet: service、server、biz、data等模塊
- (2) 到http server註冊路由: api模塊
- 程式啟動時才能順利跑完這個流程: main.go -> wireApp -> 初始化各子服務
  
    ```
    (1) 以http server為例, 加入server的ProviderSet
    參考圖 images/wire-1.png
    
    (2) 以login api為例, 將實作api介面的service註冊到http server
    參考圖 
    images/http-server-reg-1.png (原因)
    images/http-server-reg-2.png (做這一步驟就可以)
    
    ```