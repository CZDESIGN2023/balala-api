# 常見問題
## 請求http api, 404找不到
- 要到http server註冊路由
- 參考 images/http-server-reg-2.png

## gorm多字段更新失敗
- 有時候不是真的失敗, 使用Updates的時候, gorm會忽略struct中值為 0、空字串、nil 的字段
  ```
  type User struct {
      Id int64 `gorm:"primaryKey"  `
      Lock int32 `gorm:"column:lock" `
  }
  
  data := &User{
      Id:   1,
      Lock: 0,
  }
  
  // 用Updates的時候, lock字段值為0會被忽略
  cmdResult := dbModel.Updates(data)
  ```
- 處理方式:
  ```
  使用map方式填值
  data := map[string]interface{}{
      "id":   1,
      "lock": 0,
  }
  cmdResult := dbModel.Updates(data)
  ```

## gorm where條件找不到記錄時, 發生錯誤
- 找不到記錄時, 到底要不要當成錯誤應依照每個業務邏輯自行判斷
### 狀況1:
- gorm預設查詢一筆記錄時(使用First，Take，Last), 找不到記錄會返回錯誤
- 如果沒有找到匹配的記錄時不想當成錯誤, 可參考以下做法
  ```
  func (repo *XXXRepo) getXXX(ctx context.Context, id int64) (*db.User, error) 
    dbModel := repo.data.db.Where("id = ?", id)
    record := &db.User{}
    err := dbModel.Take(record).Error
    if err != nil {
      if errors.Is(err, gorm.ErrRecordNotFound) {
        // 如果沒有找到匹配的記錄時不想當成錯誤, error變數位置就回傳nil
        // db.User變數位置也用nil回傳, 自行依照業務邏輯判斷後續處理方式
        return nil, nil
      } else {
        // 其他錯誤狀況, error變數位置返回錯誤
        return nil, err
      }
    }
    // 找到匹配的目標, 可以正常使用record
    return record, nil
  }
  ```
- 大部分的情況, 應該都是找不到時需要當成錯誤, 畢竟常規操作通常都是要判斷record是不是nil之後才能取record的值開始使用
- 所以最保險的還是自己要確認撈取的record是不是nil再進行後續處理, 不要只依賴gorm的err判斷, 畢竟gorm可能被換掉
  ```
    record, err := getXXX(ctx, 1)
    if err != nil || record == nil {  // 雖然err預設已經隱含判斷record是nil的狀況, 但還是自己加上判斷比較通用
       // 返回錯誤訊息到前端
    }

    // 正常處理流程
    // ...
  ```

### 狀況2:
- 如果where條件是搭配update或delete, 找不到目標時gorm不會視為錯誤
- 業務邏輯上如果需要判斷有沒有找到記錄並操作成功, 應該要判斷執行結果的RowsAffected
  ```
    updates := map[string]interface{}{
		"name":        req.Name,
		"update_at":   now,
	}
	cmdResult := dbModel.Updates(updates)
  
    // 回傳 RowsAffected 給外部判斷
    return cmdResult.RowsAffected, cmdResult.Error
  ```

### 狀況3:
- gorm查詢多筆記錄時(使用Find), 找不到記錄不會視為錯誤
  ```
    var users []User
    err := db.Where("id IN (?)", ids).Find(&users).Error
  
    return users, err
  
    --------------------------------
    // biz收到返回值後自行依照業務邏輯判斷長度
    if len(users) == 0 {
      // 找不到記錄
    } else {
      // 找到 ...
    }
  ```